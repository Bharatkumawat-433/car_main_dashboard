<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Invoices - Car Repair</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .table-container { 
            background-color: var(--white-color); 
            padding: 25px; 
            border-radius: 8px; 
            box-shadow: var(--shadow); 
            margin-bottom: 20px; 
        }
        .table-wrapper { 
            overflow-x: auto; 
        }
        .search-container {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        #searchInput {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }
        .status-select {
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
        }
        .status-select.status-paid {
            background-color: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }
        .status-select.status-unpaid {
            background-color: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }
        .status-select.status-partial {
            background-color: var(--warning-color);
            color: var(--dark-color);
            border-color: var(--warning-color);
        }
        .btn-view-pdf {
            padding: 5px 12px;
            background-color: #17a2b8; /* Fix */
            color: white;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 500;
            display: inline-block;
        }
         .btn-view-pdf:hover {
            opacity: 0.9;
         }
    </style>

     <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>

    <script>
      // ⚠️ IMPORTANT: Apna Firebase Config object yahaan paste karein
      const firebaseConfig = {
        apiKey: "AIzaSyCuejc7aR7-dLpcXh7uUTrWDsItWxQius8",
        authDomain: "car-main-dashboard.firebaseapp.com",
        projectId: "car-main-dashboard",
        storageBucket: "car-main-dashboard.firebasestorage.app",
        messagingSenderId: "574310288597",
        appId: "1:574310288597:web:0859b5d5d453727fb2265c",
        measurementId: "G-SMNFE0421H"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore(); 
    </script>
    
    <script src="auth-guard.js"></script>
</head>
<body>

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>Car Repair Admin</h3>
            </div>
            <ul>
                <li><a href="index.html">Dashboard</a></li>
                <li><a href="create-invoice.html">Create Invoice</a></li>
                <li class="active"><a href="manage-invoices.html">Manage Invoices</a></li>
            
                <li><a href="reports.html">Reports</a></li>
                 <li><a href="#" id="logoutBtn">Logout</a></li>
            </ul>
        </nav>

        <main class="main-content"> <header class="main-header">
                 <button class="menu-toggle" id="menuToggle">&#9776;</button>
                 <h1>Manage All Invoices</h1>
            </header>
            
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Search by Invoice #, Client Name, or Phone...">
            </div>

            <div class="table-container">
                <h3>All Invoices</h3>
                 <div class="table-wrapper">
                    <table class="data-table" id="invoicesTable">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Date</th>
                                <th>Client Name</th>
                                <th>Phone</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>View PDF</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesTableBody">
                            <tr><td colspan="7" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                 </div>
            </div>

        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof db === 'undefined') {
                console.error("Firestore (db) is not initialized. Check Firebase config.");
                document.getElementById('invoicesTableBody').innerHTML = '<tr><td colspan="7" style="text-align: center; color: red;">App config error.</td></tr>';
                return;
            }

            let allInvoices = [];
            loadInvoices();

            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('keyup', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                filterTable(searchTerm);
            });

            async function loadInvoices() {
                const tableBody = document.getElementById('invoicesTableBody');
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Loading...</td></tr>';
                
                try {
                    const querySnapshot = await db.collection("invoices").orderBy("createdAt", "desc").get();
                    
                    allInvoices = []; 
                    if (querySnapshot.empty) {
                         tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No invoices found.</td></tr>';
                         return;
                    }
                    
                    querySnapshot.forEach(doc => {
                        allInvoices.push({ id: doc.id, ...doc.data() });
                    });

                    renderTable(allInvoices); 

                } catch (error) {
                    console.error("Error loading invoices: ", error);
                    tableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: red;">Error loading invoices: ${error.message}</td></tr>`;
                }
            }

            function renderTable(invoices) {
                const tableBody = document.getElementById('invoicesTableBody');
                tableBody.innerHTML = ''; 

                if (invoices.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No invoices match your search.</td></tr>';
                    return;
                }

                invoices.forEach(invoice => {
                    const row = document.createElement('tr');
                    
                    const status = invoice.status || 'Unpaid';
                    let statusClass = '';
                    if (status === 'Paid') statusClass = 'status-paid';
                    if (status === 'Unpaid') statusClass = 'status-unpaid';
                    if (status === 'Partial') statusClass = 'status-partial';

                    row.innerHTML = `
                        <td><b>${invoice.invoiceNo || invoice.id}</b></td>
                        <td>${invoice.invoiceDate || 'N/A'}</td>
                        <td>${invoice.clientName || 'N/A'}</td>
                        <td>${invoice.clientPhone || 'N/A'}</td>
                        <td>₹ ${Number(invoice.grandTotal || 0).toLocaleString('en-IN')}</td>
                        <td>
                            <select class="status-select ${statusClass}" data-invoice-id="${invoice.invoiceNo}">
                                <option value="Unpaid" ${status === 'Unpaid' ? 'selected' : ''}>Unpaid</option>
                                <option value="Paid" ${status === 'Paid' ? 'selected' : ''}>Paid</option>
                                <option value="Partial" ${status === 'Partial' ? 'selected' : ''}>Partial</option>
                            </select>
                        </td>
                        <td>
                            <a href="${invoice.pdfUrl}" target="_blank" class="btn-view-pdf">View PDF</a>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                tableBody.querySelectorAll('.status-select').forEach(select => {
                    select.addEventListener('change', handleStatusChange);
                });
            }

            function filterTable(searchTerm) {
                const filteredInvoices = allInvoices.filter(invoice => {
                    const invoiceNo = (invoice.invoiceNo || invoice.id).toLowerCase();
                    const clientName = (invoice.clientName || '').toLowerCase();
                    const clientPhone = (invoice.clientPhone || '').toLowerCase();
                    
                    return invoiceNo.includes(searchTerm) || 
                           clientName.includes(searchTerm) || 
                           clientPhone.includes(searchTerm);
                });
                renderTable(filteredInvoices);
            }

            async function handleStatusChange(e) {
                const newStatus = e.target.value;
                const invoiceId = e.target.dataset.invoiceId;
                
                if (!invoiceId) {
                    alert("Error: Could not find invoice ID.");
                    return;
                }

                e.target.className = 'status-select'; 
                if (newStatus === 'Paid') e.target.classList.add('status-paid');
                if (newStatus === 'Unpaid') e.target.classList.add('status-unpaid');
                if (newStatus === 'Partial') e.target.classList.add('status-partial');

                try {
                    const invoiceRef = db.collection("invoices").doc(invoiceId);
                    await invoiceRef.update({
                        status: newStatus
                    });
                    console.log(`Invoice ${invoiceId} status updated to ${newStatus}`);
                    
                    const invoiceInMemory = allInvoices.find(inv => inv.invoiceNo === invoiceId);
                    if(invoiceInMemory) {
                        invoiceInMemory.status = newStatus;
                    }
                    
                } catch (error) {
                    console.error("Error updating status: ", error);
                    alert(`Error updating status: ${error.message}`);
                }
            }
        });
    </script>

    <script>
        // Basic Hamburger Toggle for this page
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.querySelector('.main-content'); // Main content ko select karein

        if (menuToggle && sidebar) {
            menuToggle.addEventListener('click', (e) => { // 'e' add kiya
                e.stopPropagation(); // <-- YEH HAI FIX
                sidebar.classList.toggle('sidebar-visible');
            });
        }
        
        // Naya click-outside logic
        if (mainContent && sidebar) {
             mainContent.addEventListener('click', () => {
                if (sidebar.classList.contains('sidebar-visible')) {
                    sidebar.classList.remove('sidebar-visible');
                }
            });
        }

        // Basic Logout for this page
         const logoutBtn = document.getElementById('logoutBtn');
         if (logoutBtn) {
             logoutBtn.addEventListener('click', (e) => {
                 e.preventDefault();
                 if (confirm("Are you sure you want to logout?")) {
                     firebase.auth().signOut().then(() => { window.location.href = 'login.html'; });
                 }
             });
         }
    </script>
</body>
</html>















